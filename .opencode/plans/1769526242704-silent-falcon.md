Goal
- Track remaining risks + improvements for AI-Powered Intake Notes Analysis (backend + frontend UI/UX).

What’s solid now
- Backend analyze reads notes from DB only (no client text), validates missing/len>=20, trunc last 8000 chars, pre+post stale guards; stale path does no writes.
- Frontend Analyze cancels debounce + force-save before analyze; locks textarea while analyzing; analyze uses latest saved timestamp from store.
- Safari: AbortSignal.timeout/any removed; manual AbortController+timer + cleanup.
- Zustand reset now fresh refs (no shared Set/arrays).
- DB constraint for notes suggestions fixed via JSONB(none_as_null=True) for evidence.

Already fixed (confirmed)
- FE analyze timeout regression fixed by extending timeout; Safari Network no longer shows status “—”; UI refreshes suggestions.
- Hydrate dedupe keyed by projectId + stale result guard added.
- Notes save ordering: only latest save response updates `notesLastSavedISO`.
- Debounce canceled on projectId change.
- TS type import for `ChangeEvent`.

Remaining risks / gaps (fix these)

P0: Backend - concurrent analyze can create duplicate pending rows
- Risk: 2 analyze requests in parallel can both delete pending + both insert => duplicates (no unique constraint).
- Fix: serialize ONLY the write section (delete+insert) per project via DB lock (prefer pg advisory xact lock keyed by project_id), do NOT hold lock over LLM call.
- Files: backend/app/services/intake_ingestion_service.py

P0: Frontend - save status can become incorrect under overlapping saves
- Risk: `notesSaveStatus="saved"` can be set by older save finishing after newer save started; UI says saved but latest text not saved.
- Fix: tie `notesSaveStatus` updates to same save sequence guard as `notesLastSavedISO`.
- Files: frontend/components/features/projects/intake-panel/intake-notes-section.tsx, frontend/components/features/projects/intake-panel/intake-panel-content.tsx

P1: Backend - rate limit expensive notes analyze
- Add per-user rate limit dependency to `POST /intake/notes/analyze` to cap LLM spend.
- Files: backend/app/api/v1/intake.py, backend/app/api/dependencies.py

P1: Backend - UTC normalization in stale guard
- Risk: tz-aware but non-UTC timestamps can compare unexpectedly; enforce canonical UTC in request validation and compare.
- Files: backend/app/schemas/intake.py, backend/app/services/intake_ingestion_service.py

P1: Backend - error mapping clarity
- Risk: `ValueError` is mapped to generic 400; "too short" vs "missing" vs tz error become indistinguishable.
- Fix: map known error codes to specific `{message, code}`; keep 400.
- Files: backend/app/api/v1/intake.py

P1: Backend - transaction ownership consistency (repo-wide policy)
- Today `get_async_db()` auto-commit/rollback AND endpoints also commit/rollback; keep as-is short term, but pick one policy.
- Option A: dependency manages commit/rollback; endpoints stop committing.
- Option B: endpoints commit; dependency yields only.
- Files: backend/app/core/database.py, backend/app/api/v1/intake.py, backend/app/api/v1/files.py

P1: Backend concurrency duplicates (two analyzes same time)
- backend/app/services/intake_ingestion_service.py does delete-then-insert; concurrent analyzes can interleave => duplicates.
- Fix: serialize replace section WITHOUT holding lock over LLM call: acquire lock right before delete/insert; prefer pg advisory xact lock keyed by project_id.

P1: Evidence truthiness edge
- Likely not an actual constraint risk because evidence is a Pydantic model instance (truthy) and `evidence is None` already routes to unmapped.
- No change unless we tighten validation for “empty evidence object” as a product rule.

P2: Frontend type/format polish
- frontend/components/features/projects/intake-panel/intake-notes-section.tsx uses `React.ChangeEvent` but no `import React`; likely TS error depending config.
- Fix: `import type { ChangeEvent } from "react";` then `ChangeEvent<HTMLTextAreaElement>`.
- Optional: reformat indent drift; remove unused `_projectId` alias.

P2: Abort reason compat
- frontend/lib/api/client.ts passes abort reasons; older Safari may not support `AbortController.abort(reason)`.
- Fix: call `controller.abort()` with no arg; don’t rely on `signal.reason`.

Implementation steps (minimal, surgical)
1) Backend: lock write section for notes analyze
   - backend/app/services/intake_ingestion_service.py
2) Backend: rate limit analyze endpoint
   - backend/app/api/v1/intake.py
3) Backend: UTC normalization + clearer 400 error codes
   - backend/app/schemas/intake.py
   - backend/app/services/intake_ingestion_service.py
   - backend/app/api/v1/intake.py
4) Frontend: make save status seq-guarded
   - frontend/components/features/projects/intake-panel/intake-notes-section.tsx
   - frontend/components/features/projects/intake-panel/intake-panel-content.tsx
5) Frontend UX: cancel analyze + abort on project switch + disabled reasons
   - frontend/components/features/projects/intake-panel/intake-panel-content.tsx
   - frontend/components/features/projects/intake-panel/intake-notes-section.tsx
6) UI polish + a11y
   - frontend/components/features/projects/intake-panel/suggestion-row.tsx
   - frontend/components/features/projects/intake-panel/unmapped-notes-section.tsx
   - frontend/components/features/projects/intake-panel/intake-notes-section.tsx

Verification
- Backend: `cd backend && make check`
- Frontend: `cd frontend && bun run check:ci`
- Manual:
  - Autosave: type, wait, ensure status saved; induce save failure -> status error.
  - Analyze: click during debounce; must save then analyze; textarea locked; stale warning on concurrent edit.
  - Project switch: switch quickly during hydrate/analyze/save; must not leak data across projects; no wrong-project saves.
  - Concurrency: double-click analyze / open 2 tabs analyze simultaneously; no duplicate pending suggestions.

Open questions
- Do you want to keep mapping LLM failure as HTTP 502, or prefer 503/504? (doesn’t block other fixes)
P1: Frontend UX - analyze cancel + abort on project switch
- Add a Cancel affordance while analyzing; wire to AbortController.
- Abort analysis when projectId changes; ensure `isAnalyzing` resets.
- Files: frontend/components/features/projects/intake-panel/intake-panel-content.tsx, frontend/components/features/projects/intake-panel/intake-notes-section.tsx

P1: Frontend UX - make Analyze disabled reason obvious
- Show inline helper text for: saving, save error, too short (<20 chars), never saved.
- Files: frontend/components/features/projects/intake-panel/intake-notes-section.tsx

P2: Frontend UX - last saved display accuracy
- "Saved X ago" does not update over time; either tick a timer or display absolute time.
- Files: frontend/components/features/projects/intake-panel/intake-notes-section.tsx

P2: A11y - narrow aria-live
- Avoid `aria-live` on whole footer row; use dedicated status node (`role=status`, `aria-atomic`).
- Files: frontend/components/features/projects/intake-panel/intake-notes-section.tsx

P2: UX - staleIgnored microcopy + actions
- Toast copy: explain "skipped" + next step; optional action "Run again" / focus notes.
- Files: frontend/components/features/projects/intake-panel/intake-panel-content.tsx

P2: UI polish - Notes provenance discoverability
- Make "Notes" badge more visible (icon/tooltip) and optionally clickable to scroll to Intake Notes.
- Files: frontend/components/features/projects/intake-panel/suggestion-row.tsx (+ any badge component usage)

P2: Unmapped notes UX
- Improve empty state (don’t render nothing), fix confusing copy, consider confirm on bulk dismiss.
- Files: frontend/components/features/projects/intake-panel/unmapped-notes-section.tsx

P3: Performance - derived selectors + large lists
- Use existing store selectors for filter options to reduce rerenders; consider "Load more" (no virtualization deps).
- Files: frontend/components/features/projects/intake-panel/suggestion-filters.tsx, frontend/components/features/projects/intake-panel/ai-suggestions-section.tsx
