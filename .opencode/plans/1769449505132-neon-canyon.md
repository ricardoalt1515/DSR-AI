# Intake Panel Horizontal Clip Fix

## Problem
- Intake panel looks fine when AI suggestions empty, but once suggestions render it overflows horizontally then gets clipped (many ancestors `overflow-hidden` / `overflow-x-hidden`).

## Root cause (real)
- Per repro: only happens when suggestions render; other intake UI fine.
- Primary overflow still present after Row2/Row4 fixes: `frontend/components/features/projects/intake-panel/suggestion-row.tsx` ValueBadge.
  - `ValueBadge` uses `inline-flex` (shrink-to-fit) + `truncate` (nowrap) but the span is missing `min-w-0`.
  - Inside Radix ScrollArea, children live under an internal `display: table` wrapper; any max-content/nowrap child can widen the table => panel-wide horizontal overflow then clipped.

## Non-goals (defer)
- Apply UX / batch apply / undo semantics / refactors.
- Resizable sizing changes (keep current UX: resizable panel).
- Global `ScrollArea` behavior changes (avoid blast radius).

## Fix (recommended)

### 1) Make flex truncation actually work (primary fix)

- Edit `frontend/components/features/projects/intake-panel/suggestion-row.tsx`:
  - ValueBadge: stop max-content sizing.
    - Add shrink perms where truncation is.
      - Preferred: `motion.div` `inline-flex ...` -> `inline-flex min-w-0 max-w-full ...` (or `flex w-full min-w-0 ...` if you want full-width pill).
      - Value span: `truncate ...` -> `min-w-0 truncate ...`.
  - (Already done) Row 2/Row 4: `min-w-0` + `flex-1 truncate` on truncating spans; keep non-text `shrink-0`.

### 1b) Secondary local fixes if overflow persists

- Edit `frontend/components/features/projects/intake-panel/evidence-drawer.tsx`:
  - File row has `truncate` inside a flex row but missing `min-w-0`.
  - Make filename span a shrinkable flex item:
    - Row: ensure `min-w-0` on container OR wrap filename in `min-w-0 flex-1`.
    - Filename span: `truncate ...` -> `min-w-0 flex-1 truncate ...` (page stays `shrink-0`).

- If culprit ends up being Textarea in a flex row:
  - Prefer callsite fix first (add `min-w-0` on wrapper/textarea).
  - Optional global: add `min-w-0` to `frontend/components/ui/textarea.tsx` base classes (Input already has it).

### 2) Verify no horizontal overflow
- Manual:
  - Create/choose suggestions with very long `sectionTitle`, `evidence.filename`, and a very long `value` (pill).
  - Shrink intake panel; confirm ellipsis works; no right-edge cut-off; no horizontal scrollbar.
  - DevTools: in `[data-radix-scroll-area-viewport]` confirm content wrapper `scrollWidth <= clientWidth`.

- Console quick check (any page state):
  - `document.documentElement.scrollWidth - document.documentElement.clientWidth` should be `0`.

### 3) Only if still broken (debug branch)
- Temporarily change `frontend/components/features/projects/intake-panel/ai-suggestions-section.tsx` list container `overflow-x-hidden` -> `overflow-x-auto` to reveal what still overflows; then fix the actual offender.

- Secondary suspect if still overflow: `frontend/components/features/projects/intake-panel/evidence-drawer.tsx` has `truncate` in a flex row without `min-w-0 flex-1` on filename span.

## Tests
- `cd frontend && bun run check:ci`

## Notes
- Avoid changing shared `Button` base (`whitespace-nowrap shrink-0`) or `ScrollArea` overflow rules unless local fixes fail; those changes hide real offenders + wider blast radius.

## Open questions
- None (user chose: keep panel resizable).

---

# Next: AI Suggestions UX + Evidence + Undo

## Goals
- Make SuggestionRow more scannable + explicit (esp willReplace).
- Evidence clickable + trustworthy + keyboard-safe.
- Add Undo for batch apply/reject with correct semantics (backend-backed).
- Keep single scroll boundary (already).

## Non-goals
- Add extraction offsets / text highlighting in notes.
- Redesign resizable layout.
- Local-only “undo” that diverges from backend truth.

## Current constraints (from repo)
- Suggestions list: no grouping/sorting; store filters only (confidence/section/source).
- EvidenceDrawer exists but not used in SuggestionRow.
- Undo exists only for batch; store-only; 15s TTL; does not revert backend or technical-data.
- Frontend toast lib: sonner.

## Plan (recommended)

### 1) SuggestionRow layout + willReplace clarity
- Edit `frontend/components/features/projects/intake-panel/suggestion-row.tsx`
  - Restructure to 3-line “value-first” row (still one card):
    - L1: checkbox + value badge (primary) + actions (Apply/Replace + Reject)
    - L2: fieldLabel (strong) + sectionTitle (muted) + confidence
    - L3: evidence trigger row (button)
  - Make `willReplace` unmissable:
    - Add small badge/label next to Apply: `Replace` vs `Apply`.
    - Add muted warning microcopy only when `willReplace`: “Replaces existing value”.
  - Keep strict overflow discipline: `min-w-0` on flex items; only text truncates; non-text `shrink-0`.
  - Confidence display: round for UI (avoid long decimals).

### 2) Evidence: clickable + inline proof
- Reuse inline EvidenceDrawer instead of inventing new modal.
- Edit `frontend/components/features/projects/intake-panel/suggestion-row.tsx`
  - Replace filename text row with a real control (button / collapsible trigger) wired to `EvidenceDrawer`.
  - Keep filename truncation + title tooltip.
- Edit `frontend/components/features/projects/intake-panel/evidence-drawer.tsx`
  - Add optional “Open file” action (button) when `fileId` available.
  - Keep a11y: focusable trigger, `aria-expanded`, visible focus ring.

### 3) Suggestions ordering (small win)
- Edit `frontend/components/features/projects/intake-panel/ai-suggestions-section.tsx`
  - Derive display list (no store changes):
    - Group headers: `Ready to apply` (willReplace=false) then `Will replace existing`.
    - Sort within group: confidence desc, then sectionTitle/fieldLabel for stability.
  - Ensure `visibleIds` uses the displayed order (shift-range selection correctness).

### 4) REAL Undo (15s) across backend + frontend

### 4) Undo (defer)
- User chose: skip Undo until backend supports correct semantics.
- (Optional future): implement backend-backed undo token + endpoint; do not ship local-only undo.

## Verification
- Frontend: `cd frontend && bun run check:ci`
- Backend: `cd backend && make check`
- Manual:
  - Narrow intake panel; long value/section/file name: no horizontal overflow; ellipsis ok.
  - Replace row clearly labeled; confirm dialog still triggers correctly.
  - Evidence trigger keyboard: Tab -> Enter/Space toggles; focus ring visible.
- Batch apply/reject: no Undo toast (by design).

## Open questions
 - Evidence click: inline drawer + Open file (chosen).
 - Suggestion ordering: group+sort (chosen).
