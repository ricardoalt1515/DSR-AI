# Plan: Fix usePermissions Bug + Production Prep

## Contexto

Backend RBAC implementado:
- `created_by_user_id` en Company/Location (schema expone)
- Agents solo editan sus propios records
- Admins editan todo

Frontend gaps:
- Botones edit/delete visibles para TODOS con `canWriteClientData`
- No verifica ownership
- 403 hace logout (muy agresivo)

## Alcance

1. **Ownership-aware UI**: Ocultar edit si no eres creador (agents)
2. **403 handling**: Toast error, no logout

---

## Implementación

### 1. Tipos: agregar `createdByUserId`

**`frontend/lib/types/company.ts`**

```typescript
export interface CompanySummary extends CompanyBase {
  id: string;
  locationCount: number;
  createdAt: string;
  updatedAt: string;
  createdByUserId?: string;  // ADD
}

export interface LocationSummary extends LocationBase {
  id: string;
  companyId: string;
  fullAddress: string;
  projectCount: number;
  createdAt: string;
  updatedAt: string;
  createdByUserId?: string;  // ADD
}
```

### 2. Hook de permisos: `usePermissions`

**Crear `frontend/lib/hooks/use-permissions.ts`**

```typescript
import { useAuth } from "@/lib/contexts/auth-context";
import type { CompanySummary, LocationSummary } from "@/lib/types/company";

export function usePermissions() {
  const { user, canWriteClientData } = useAuth();

  const canEditCompany = (company: CompanySummary): boolean => {
    if (!canWriteClientData) return false;
    if (user?.isSuperuser || user?.role === "org_admin") return true;
    return company.createdByUserId === user?.id;
  };

  const canEditLocation = (location: LocationSummary): boolean => {
    if (!canWriteClientData) return false;
    if (user?.isSuperuser || user?.role === "org_admin") return true;
    return location.createdByUserId === user?.id;
  };

  const canDeleteCompany = (): boolean => {
    return Boolean(user?.isSuperuser || user?.role === "org_admin");
  };

  const canDeleteLocation = (): boolean => {
    return Boolean(user?.isSuperuser || user?.role === "org_admin");
  };

  return { canEditCompany, canEditLocation, canDeleteCompany, canDeleteLocation };
}
```

### 3. Company detail: condicionar Edit button

**`frontend/app/companies/[id]/page.tsx`**

```diff
+ import { usePermissions } from "@/lib/hooks/use-permissions";

  const { canWriteClientData } = useAuth();
+ const { canEditCompany } = usePermissions();

- {canWriteClientData && (
+ {canEditCompany(currentCompany) && (
    <Button onClick={() => setEditCompanyDialogOpen(true)}>
      <Edit /> Edit Company
    </Button>
  )}
```

### 4. Location cards: condicionar edit/delete

Mismo archivo, en DropdownMenu de locations:

```diff
+ const { canEditLocation, canDeleteLocation } = usePermissions();

  <DropdownMenuContent>
+   {canEditLocation(location) && (
+     <DropdownMenuItem onClick={() => handleEditLocation(location)}>
+       <Edit /> Edit
+     </DropdownMenuItem>
+   )}
-   <DropdownMenuItem disabled>
-     <Trash2 /> Delete (Coming soon)
-   </DropdownMenuItem>
+   {canDeleteLocation() && (
+     <DropdownMenuItem onClick={() => { setLocationToDelete(location); setDeleteDialogOpen(true); }}>
+       <Trash2 /> Delete
+     </DropdownMenuItem>
+   )}
  </DropdownMenuContent>
```

### 5. 403 handling: toast en vez de logout

**`frontend/lib/contexts/auth-context.tsx`**

```diff
  const refreshUser = async () => {
    try {
      const currentUser = await authAPI.getCurrentUser();
      setUser(currentUser);
    } catch (error: unknown) {
      const status = error?.status;
-     if (status === 401 || status === 403) {
+     if (status === 401) {
        setUser(null);
      }
+     // 403: Keep session, action was denied (not auth failure)
    }
  };
```

**`frontend/lib/api/client.ts`** - agregar 403 toast:

```diff
+ import { toast } from "sonner";

  if (response.status === 403) {
+   toast.error("You don't have permission to perform this action");
    // Don't logout, just reject
  }
```

---

## Archivos a Modificar

```
frontend/lib/types/company.ts              # +2 campos
frontend/lib/hooks/use-permissions.ts      # NUEVO
frontend/app/companies/[id]/page.tsx       # Usar hook
frontend/lib/contexts/auth-context.tsx     # 403 != logout
frontend/lib/api/client.ts                 # 403 toast
```

---

## Verificación

```bash
cd frontend && bun run check:ci
```

Test manual:
1. Login como field_agent
2. Crear company → Edit button visible ✅
3. Ver company de otro → Edit button oculto ✅
4. Intentar editar via URL → 403 toast, no logout ✅
5. Login como org_admin → Edit visible en todas ✅

---

# REVIEW: Bug Found - Production Fixes Required

## BUG CRÍTICO: usePermissions bloquea agents

`canEditCompany()` usa `canWriteClientData` como primera verificación, pero eso solo es true para admins.

```typescript
// ACTUAL (buggy) - use-permissions.ts:7
const canEditCompany = (company: CompanySummary): boolean => {
  if (!canWriteClientData) return false;  // ❌ Agents ALWAYS return false here
  ...
};
```

**Resultado**: Field agents no pueden ver botón Edit en sus propias companies.

### Fix Requerido

```typescript
// CORRECTO
export function usePermissions() {
  const { user } = useAuth();

  const isAdmin = user?.isSuperuser || user?.role === "org_admin";
  const isAgent = user?.role === "field_agent" || user?.role === "contractor";

  const canEditCompany = (company: CompanySummary): boolean => {
    if (isAdmin) return true;
    return isAgent && company.createdByUserId === user?.id;
  };

  const canEditLocation = (location: LocationSummary): boolean => {
    if (isAdmin) return true;
    return isAgent && location.createdByUserId === user?.id;
  };

  const canDeleteCompany = (): boolean => isAdmin;
  const canDeleteLocation = (): boolean => isAdmin;

  return { canEditCompany, canEditLocation, canDeleteCompany, canDeleteLocation };
}
```

## Issues Menores (Opcional)

1. **Toast duplicado en 403**: client.ts + component catch = 2 toasts
   - Fix: Usar toast ID `toast.error("...", { id: "permission-denied" })`

2. **"New Waste Stream" sin permiso check**: Location detail page no tiene gating
   - Backend protege, pero UI debería ocultar botón
