# Plan: Tests de Endpoints CRUD, Auth, Projects, Files, Organizations

## Estado actual: 37 tests (RBAC + Multi-tenancy + Security) ✅ Completado

---

## Tests a agregar (~44 nuevos)

### 1. `test_crud_companies_locations.py` (~12 tests)

| Test | Endpoint | Validación |
|------|----------|------------|
| `test_list_companies` | GET /companies | Returns list, org-scoped |
| `test_create_company_success` | POST /companies | 201, validates required fields |
| `test_create_company_invalid_sector` | POST /companies | 422 on invalid sector |
| `test_get_company_detail` | GET /companies/{id} | Returns company + locations |
| `test_get_company_not_found` | GET /companies/{id} | 404 for non-existent |
| `test_update_company` | PUT /companies/{id} | 200, partial update works |
| `test_list_locations` | GET /companies/locations | Returns list with projectCount |
| `test_create_location_success` | POST /companies/{id}/locations | 201 |
| `test_get_location_detail` | GET /companies/locations/{id} | Returns location + projects + contacts |
| `test_update_location` | PUT /companies/locations/{id} | 200 |
| `test_delete_location_cascades` | DELETE /companies/locations/{id} | Removes contacts too |
| `test_list_locations_filters_by_company` | GET /companies/locations?company_id= | Filters work |

### 2. `test_auth.py` (~8 tests)

| Test | Endpoint | Validación |
|------|----------|------------|
| `test_login_success` | POST /auth/jwt/login | Returns access_token |
| `test_login_wrong_password` | POST /auth/jwt/login | 400 Bad Request |
| `test_login_nonexistent_user` | POST /auth/jwt/login | 400 Bad Request |
| `test_get_me` | GET /auth/me | Returns current user |
| `test_update_me` | PATCH /auth/me | Updates profile |
| `test_protected_endpoint_no_token` | GET /projects | 401 Unauthorized |
| `test_protected_endpoint_invalid_token` | GET /projects | 401 Unauthorized |
| `test_protected_endpoint_expired_token` | GET /projects | 401 (si se puede simular) |

### 3. `test_projects.py` (~10 tests)

| Test | Endpoint | Validación |
|------|----------|------------|
| `test_list_projects_empty` | GET /projects | Returns empty paginated response |
| `test_list_projects_paginated` | GET /projects | Pagination works |
| `test_list_projects_search` | GET /projects?search= | Search filter works |
| `test_list_projects_status_filter` | GET /projects?status= | Status filter works |
| `test_create_project_success` | POST /projects | 201, creates with location_id |
| `test_create_project_invalid_location` | POST /projects | 404 for non-existent location |
| `test_get_project_detail` | GET /projects/{id} | Returns full project with files |
| `test_update_project` | PUT /projects/{id} | 200, updates fields |
| `test_update_project_status` | PUT /projects/{id} | Status transition works |
| `test_dashboard_stats` | GET /projects/dashboard/stats | Returns aggregated stats |

### 4. `test_files.py` (~6 tests)

| Test | Endpoint | Validación |
|------|----------|------------|
| `test_upload_file_success` | POST /projects/{id}/files | 201, accepts PDF/DOCX |
| `test_upload_file_invalid_type` | POST /projects/{id}/files | 400 for .exe |
| `test_upload_file_too_large` | POST /projects/{id}/files | 400 (if enforced) |
| `test_list_project_files` | GET /projects/{id}/files | Returns file list |
| `test_get_file_download_url` | GET /projects/{id}/files/{file_id} | Returns presigned URL |
| `test_delete_file` | DELETE /projects/{id}/files/{file_id} | 200 |

### 5. `test_organizations.py` (~8 tests)

| Test | Endpoint | Validación |
|------|----------|------------|
| `test_get_current_org` | GET /organizations/current | Returns org details |
| `test_list_org_users_as_admin` | GET /organizations/current/users | Admin sees all users |
| `test_list_org_users_as_agent_forbidden` | GET /organizations/current/users | 403 for agent |
| `test_create_org_user_as_admin` | POST /organizations/current/users | 201 creates user |
| `test_create_org_user_cannot_create_platform_admin` | POST /organizations/current/users | 400 for role=admin |
| `test_update_org_user` | PUT /organizations/current/users/{id} | 200 |
| `test_superadmin_list_all_orgs` | GET /organizations | SuperAdmin only |
| `test_superadmin_create_org` | POST /organizations | SuperAdmin only |

---

## Archivos a crear

```
backend/tests/
├── conftest.py                          # ✅ Ya existe
├── test_crud_companies_locations.py     # NUEVO - 12 tests
├── test_auth.py                         # NUEVO - 8 tests  
├── test_projects.py                     # NUEVO - 10 tests
├── test_files.py                        # NUEVO - 6 tests
├── test_organizations.py                # NUEVO - 8 tests
```

---

## Helpers adicionales en conftest.py

```python
async def login_user(client, email: str, password: str = "Password1") -> str:
    """Login and return access token."""
    resp = await client.post("/api/v1/auth/jwt/login", data={
        "username": email,
        "password": password,
    })
    return resp.json()["access_token"]

def auth_headers(token: str) -> dict:
    """Return Authorization header dict."""
    return {"Authorization": f"Bearer {token}"}
```

---

## Verificación

```bash
# Correr todos los tests nuevos
cd backend && docker compose exec app python -m pytest tests/ -v \
  --ignore=tests/test_intelligent_case_filter_v2.py \
  --ignore=tests/test_v1_improvements.py

# Resultado esperado: ~81 tests (37 actuales + 44 nuevos)
```

---

## Orden de implementación

1. `test_auth.py` - Base para todos los demás (login/token)
2. `test_crud_companies_locations.py` - CRUD básico
3. `test_projects.py` - Core business logic
4. `test_files.py` - File handling
5. `test_organizations.py` - Admin features
