# Simplified Industry Field Implementation

## Analysis Summary

### Question 1: Is a migration really necessary?

**No, a migration is NOT necessary.** Here's why:

1. **No production data** - The codebase is pre-production
2. **"Zero tech debt" principle** - The CLAUDE.md explicitly says "no compatibility shims"
3. **Migrations exist for sector** - There's already `20251106_0740-d5e6f7g8h9i0_add_sector_to_company.py` adding sector

**Recommendation:** Modify the initial schema migration directly OR squash all migrations into a clean baseline. This is the cleanest approach for a pre-production system.

---

### Question 2: Can we simplify the 7-phase approach?

**Yes, dramatically.** The original plan has 7 phases. We can reduce to **2 phases**:

| Original | Simplified |
|----------|------------|
| Phase 1: Config FE | Phase 1: All backend (model, schema, config) |
| Phase 2: Backend Model + Migration | |
| Phase 3: Backend Schemas | |
| Phase 4: Frontend Types | Phase 2: All frontend (types, config, components) |
| Phase 5: UI Components | |
| Phase 6: Propagation | (included in Phase 1 & 2) |
| Phase 7: industryApplications | (defer - marked as future iteration in original) |

---

### Question 3: Unnecessary steps identified

1. **Migration with server_default + alter_column** - Not needed, modify initial schema
2. **Separate migration file** - Delete and recreate DB
3. **downgrade() logic** - No production rollback needed
4. **Creating new files when renaming works** - e.g., `compact-sector-select.tsx` can be renamed in-place
5. **sectorApplications → industryApplications** - Already marked as "future iteration" in plan, skip entirely
6. **Gradual propagation** - Just do search-replace across all files at once

---

### Question 4: Most efficient order of changes

```
1. Backend model + schema (atomic)
2. Reset database (alembic downgrade base && alembic upgrade head)
3. Frontend types + config (atomic)
4. Frontend components (search-replace)
5. Tests (update fixtures)
```

---

## Current State Analysis

### Models affected:
| Model | Current Fields | New Fields |
|-------|----------------|------------|
| Company | `sector`, `subsector`, `industry` (3 fields) | `industry`, `sub_industry` (2 fields) |
| Project | `sector`, `subsector` | `industry`, `sub_industry` |
| User | `sector`, `subsector` | `industry`, `sub_industry` |

### Key insight: Company has 3 fields, others have 2
- Company: `sector` + `subsector` + `industry` (industry is AI-generated text, marked as debt)
- Project/User: `sector` + `subsector` only

The plan correctly removes all 3 from Company, reduces to 2 everywhere.

---

## Minimal Implementation Approach

### Phase 1: Backend (1 atomic commit)

**Files to modify:**

1. `backend/app/models/company.py` - Remove `sector`, `subsector`, `industry`, add `industry`, `sub_industry`
2. `backend/app/models/project.py` - Replace `sector`/`subsector` with `industry`/`sub_industry`
3. `backend/app/models/user.py` - Replace `sector`/`subsector` with `industry`/`sub_industry`
4. `backend/app/schemas/company.py` - Update field names
5. `backend/app/schemas/project.py` - Update field names
6. `backend/app/schemas/user_fastapi.py` - Update field names
7. `backend/app/api/dependencies.py` - `SectorFilter` → `IndustryFilter`
8. `backend/tests/conftest.py` - Update fixtures

**Database reset:**
```bash
cd backend
alembic downgrade base
alembic revision --autogenerate -m "industry_subindustry_schema"
alembic upgrade head
```

### Phase 2: Frontend (1 atomic commit)

**Files to modify/rename:**

1. `frontend/lib/sectors-config.ts` → rename to `industries-config.ts`, new taxonomy
2. `frontend/lib/types/company.ts` - Update imports and types
3. `frontend/lib/types/user.ts` - Update if sector/subsector exists
4. `frontend/components/shared/forms/compact-sector-select.tsx` → rename to `compact-industry-select.tsx`
5. `frontend/components/features/companies/create-company-dialog.tsx` - Use new component
6. Search-replace across ~20 remaining frontend files

---

## Files that can be modified inline (no new files needed)

All existing files can be modified in-place:

| File | Change Type |
|------|-------------|
| `backend/app/models/company.py` | Inline edit |
| `backend/app/models/project.py` | Inline edit |
| `backend/app/models/user.py` | Inline edit |
| `backend/app/schemas/company.py` | Inline edit |
| `frontend/lib/sectors-config.ts` | Rename + edit |
| `frontend/lib/types/company.ts` | Inline edit |
| `compact-sector-select.tsx` | Rename + edit |

**Only new file needed:** One new Alembic migration (auto-generated)

---

## Concrete Recommendations

### 1. Skip migration complexity entirely
Since no production data exists, just:
- Modify the SQLAlchemy models directly
- Run `alembic revision --autogenerate`
- The autogenerated migration will handle the column renames

### 2. Consolidate from 7 phases to 2 commits
- **Commit 1:** All backend changes + migration
- **Commit 2:** All frontend changes

### 3. Skip industryApplications entirely
The original plan already deferred this. Don't create empty structures - just remove `sectorApplications` and add `industryApplications` when actually needed.

### 4. Use search-replace aggressively
```bash
# Backend
rg -l "sector|subsector" backend/app --type py | xargs sed -i '' 's/sector/industry/g'
# (with manual review)

# Frontend
rg -l "sector|subsector" frontend/lib frontend/components --type ts --type tsx
```

### 5. Rename files instead of create+delete
```bash
git mv frontend/lib/sectors-config.ts frontend/lib/industries-config.ts
git mv frontend/components/shared/forms/compact-sector-select.tsx frontend/components/shared/forms/compact-industry-select.tsx
```

---

## Estimated Time

| Phase | Original Estimate | Simplified Estimate |
|-------|-------------------|---------------------|
| Backend | 4 hours | 1.5 hours |
| Frontend | 3 hours | 1.5 hours |
| Tests | 1 hour | 0.5 hours |
| **Total** | **8 hours** | **3.5 hours** |

---

## Risk Assessment

**Low risk because:**
1. No production data to preserve
2. Full test suite validates changes
3. TypeScript catches frontend type mismatches
4. Alembic autogenerate catches model/DB drift

**One consideration:** If there's dev/staging data you want to keep, you'd need a simple data migration. But per "zero tech debt" principle, starting fresh is cleaner.

---

## Execution Checklist

- [ ] Phase 1: Backend
  - [ ] Update `company.py` model (remove 3 fields, add 2)
  - [ ] Update `project.py` model
  - [ ] Update `user.py` model
  - [ ] Update all schemas
  - [ ] Update `dependencies.py` (SectorFilter → IndustryFilter)
  - [ ] Generate Alembic migration
  - [ ] Reset local DB
  - [ ] Update test fixtures
  - [ ] Run `make check`

- [ ] Phase 2: Frontend
  - [ ] Rename `sectors-config.ts` → `industries-config.ts` with new taxonomy
  - [ ] Update `company.ts` types
  - [ ] Rename `compact-sector-select.tsx` → `compact-industry-select.tsx`
  - [ ] Search-replace across all files
  - [ ] Run `bun run check:ci`
  - [ ] Manual test: create company with new dropdown
